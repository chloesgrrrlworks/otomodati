<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お友達記録アプリ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      font-family: 'Yomogi', sans-serif;
      margin:0; padding:0;
      background:#fdfdfd;
    }
    header, footer {
      text-align:center;
      padding:10px;
    }
    header button {
      margin:0 5px;
      padding:6px 12px;
      font-family: 'Yomogi', sans-serif;
    }
    .board {
      position:relative;
      width:100%;
      min-height:70vh;
      border:1px solid #ccc;
      overflow:hidden;
    }
    .note {
      position:absolute;
      padding:8px;
      width:160px;
      background:#fff9b1;
      border:1px solid #aaa;
      border-radius:6px;
      word-break:normal;
      overflow-wrap:anywhere;
      white-space:nowrap;
    }
    .note.two-lines {
      white-space:normal;
    }
    .note .close {
      position:absolute;
      top:2px; right:6px;
      cursor:pointer;
      font-weight:bold;
    }
    .grayscale {
      filter:grayscale(100%);
    }
    .modal {
      display:none;
      position:fixed;
      z-index:999;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
    }
    .modal-content {
      background:#fff;
      margin:20% auto;
      padding:20px;
      border-radius:10px;
      width:80%;
      max-width:300px;
      text-align:center;
    }
    .friend-photo {
      width:100px;
      height:100px;
      object-fit:cover;
      border-radius:50%;
      border:2px solid #333;
    }
    footer img {
      height:40px;
    }
  </style>
</head>
<body>
  <header>
    <button onclick="location.hash='#/list'">← 一覧へ</button>
    <button onclick="addNote()">＋付箋</button>
    <button onclick="addToday()">今日会った</button>
    <button onclick="backup()">バックアップ保存</button>
    <button onclick="toggleTheme()">テーマ切替</button>
  </header>

  <main>
    <div class="board" id="board"></div>
  </main>

  <footer>
    <img src="CGW_LOGO.png" alt="CGW Logo" 
         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%23ccc%22/></svg>'">
  </footer>

  <!-- 初回必須入力モーダル -->
  <div id="initModal" class="modal">
    <div class="modal-content">
      <h3>最初に入力してください</h3>
      <label>呼び方<br><input id="initName"></label><br><br>
      <label>出会った場所<br><input id="initPlace"></label><br><br>
      <button onclick="submitInit()">OK</button>
    </div>
  </div>

<script>
  const board = document.getElementById('board');
  const colors = ['#fff9b1','#b1fff2','#f9b1ff','#b1d1ff','#ffd1b1'];

  // デモデータをseed
  function seed() {
    const y=new Date().getFullYear();
    const demo = {
      id: uuid(),
      name:'クロエ', breed:'フラットコーテッドレトリーバー',
      created:`${y}`,
      photoDataURL:'CGW_LOGO.png',
      goodbyeActive:false,
      demo:true,
      notes:[{text:'出会った場所：代々木公園', x:30,y:40,colorId:0}]
    };
    saveFriends([demo]);
  }

  function uuid(){return 'xxxxxx'.replace(/x/g,()=>Math.floor(Math.random()*16).toString(16));}
  function loadFriends(){return JSON.parse(localStorage.getItem('friends')||'[]');}
  function saveFriends(fs){localStorage.setItem('friends',JSON.stringify(fs));}

  // 初期ロード
  window.onload=()=>{
    let fs=loadFriends();
    if(fs.length===0) seed();
    renderList();
    // 初回ならモーダル表示
    if(!localStorage.getItem('initDone')) document.getElementById('initModal').style.display='block';
  };

  function renderList(){
    board.innerHTML='';
    let fsAll=loadFriends();
    const hasReal=fsAll.some(f=>!f.demo);
    let fs= hasReal? fsAll.filter(f=>!f.demo): fsAll;

    fs.forEach(f=>{
      f.notes.forEach(n=>drawNote(n.text,n.x,n.y,n.colorId,f.goodbyeActive));
    });
  }

  function drawNote(text,x,y,colorId,gray){
    let note=document.createElement('div');
    note.className='note';
    if(text.length>12) note.classList.add('two-lines');
    if(gray) note.classList.add('grayscale');
    note.style.background=colors[colorId%colors.length];
    note.style.left=x+'px'; note.style.top=y+'px';
    note.textContent=text.slice(0,24);
    let c=document.createElement('span');
    c.textContent='×'; c.className='close';
    c.onclick=()=>note.remove();
    note.appendChild(c);
    board.appendChild(note);
  }

  function addNote(){
    let t=prompt('付箋内容を入力してください');
    if(!t) return;
    pushNote(t);
  }
  function addToday(){
    let d=new Date().toLocaleDateString();
    pushNote(`今日会った：${d}`);
  }
  function pushNote(text){
    let fs=loadFriends();
    let hasReal=fs.some(f=>!f.demo);
    if(!hasReal) fs=fs.filter(f=>!f.demo);
    let f=fs[0]||{id:uuid(),notes:[]};
    f.notes.push({text,x:50,y:50,colorId:Math.floor(Math.random()*colors.length)});
    fs.push(f);
    saveFriends(fs);
    renderList();
  }

  function backup(){
    const blob=new Blob([JSON.stringify(loadFriends(),null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download="backup.json"; a.click();
    URL.revokeObjectURL(url);
  }

  function toggleTheme(){
    document.body.classList.toggle('dark');
  }

  function submitInit(){
    const n=document.getElementById('initName').value.trim();
    const p=document.getElementById('initPlace').value.trim();
    if(!n||!p) return alert('必須です！');
    let fs=loadFriends().filter(f=>!f.demo);
    const f={id:uuid(),notes:[
      {text:'呼び方：'+n,x:30,y:30,colorId:1},
      {text:'出会った場所：'+p,x:200,y:60,colorId:2}
    ]};
    fs.push(f);
    saveFriends(fs);
    localStorage.setItem('initDone','1');
    document.getElementById('initModal').style.display='none';
    renderList();
  }
</script>
</body>
</html>
