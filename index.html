<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>お友達記録アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-180.png" />
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa;--fg:#222;--card:#fff;--muted:#666;--border:#e6e6e6;--btn:#fff;--btn-bd:#ddd;--link:#1a73e8;
      --note1:#FFF6A3;--note2:#FFD5E5;--note3:#C9F0FF;--note4:#CFF8C6;--note5:#E9DCFF;--danger:#d84a4a;
    }
    [data-theme="dark"]{
      --bg:#111215;--fg:#eee;--card:#1a1c20;--muted:#a0a4ab;--border:#2a2d33;--btn:#20242a;--btn-bd:#343842;--link:#7ab4ff;
      --note1:#6a641f;--note2:#6a3347;--note3:#244655;--note4:#2b5230;--note5:#3d3a63;
    }
    [data-theme="hc"]{
      --bg:#fff;--fg:#000;--card:#fff;--muted:#000;--border:#000;--btn:#fff;--btn-bd:#000;--link:#00f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans JP",sans-serif}
    header{position:sticky;top:0;z-index:10;display:flex;gap:.75rem;align-items:center;background:var(--card);border-bottom:1px solid var(--border);padding:.75rem 1rem}
    header h1{margin:0;font-size:1.05rem}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--btn-bd);background:var(--btn);color:var(--fg);padding:.5rem .8rem;border-radius:.6rem;cursor:pointer}
    .btn.primary{background:var(--fg);color:var(--bg);border-color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:1rem}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card .ph{aspect-ratio:4/3;background:#e9e9e9;display:grid;place-items:center;color:#999}
    [data-theme="dark"] .card .ph{background:#2a2d33;color:#777}
    .card .body{padding:.75rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    label{font-size:.85rem;color:var(--muted)}
    input,select,textarea{font:inherit;border:1px solid var(--btn-bd);background:var(--btn);color:var(--fg);padding:.5rem .6rem;border-radius:.5rem}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    footer{display:flex;justify-content:center;align-items:center;gap:.5rem;color:var(--muted);padding:1rem}
    footer img{height:20px}

    /* 編集ビュー（付箋） */
    .stage{position:relative;width:100%;aspect-ratio:4/3;background:#e0e0e0;overflow:hidden;border-radius:12px}
    [data-theme="dark"] .stage{background:#2a2d33}
    .stage img{width:100%;height:100%;object-fit:cover;display:block}
    .note{position:absolute;min-width:120px;max-width:240px;min-height:80px;padding:10px 12px 24px 12px;border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,.18);font-family:"Yomogi",cursive;font-size:16px;line-height:1.4;cursor:grab;user-select:none;touch-action:none;border:1px solid rgba(0,0,0,.06)}
    .note.dragging{opacity:.85;cursor:grabbing}
    .note .close{position:absolute;right:6px;top:6px;width:24px;height:24px;border-radius:999px;background:#fff;border:2px solid var(--danger);color:var(--danger);font-weight:700;line-height:19px;text-align:center;display:none;cursor:pointer}
    .note.show-close .close{display:inline-block}
    .note[data-color="1"]{background:var(--note1)} .note[data-color="2"]{background:var(--note2)}
    .note[data-color="3"]{background:var(--note3)} .note[data-color="4"]{background:var(--note4)} .note[data-color="5"]{background:var(--note5)}
    .overlay{position:absolute;inset:0;background:rgba(120,120,120,.45);display:none;align-items:flex-end;justify-content:flex-end;padding:8px;color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .goodbye .overlay{display:flex}
    .info{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;margin-top:.75rem}
    .hint{opacity:.75;font-size:.9rem}

    /* view toggles */
    [data-view]{display:none}
    [data-view].on{display:block}

    /* モーダルの簡易スタイル */
    dialog{border:1px solid var(--border);border-radius:12px;padding:0;background:var(--card);color:var(--fg);max-width:520px;width:min(92vw,520px)}
    dialog::backdrop{background:rgba(0,0,0,.3)}
    .error{color:#b00020;font-size:.85rem}
    .invalid{border-color:#b00020 !important; outline:0}

    /* 付箋テキスト制御 */
    .note .content{ white-space: pre-wrap; }
    .note .content.single-line{ white-space: nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>お友達記録アプリ</h1>
    <div class="spacer"></div>
    <button class="btn primary">新規追加</button>
  </header>
  <main class="container">
    <div class="grid cards" id="friendsList">
      <!-- カード一覧 -->
    </div>
  </main>
  <footer>
    <img src="CGW_LOGO.png" alt="Chloe's Grrrl Works" />
    <span>Chloe's Grrrl Works</span>
  </footer>

  <script>
    // ========== 追加ユーティリティ ==========
    function isHEIC(file){
      const name = (file?.name || '').toLowerCase();
      const type = (file?.type || '').toLowerCase();
      return type.includes('heic') || name.endsWith('.heic') || type.includes('heif');
    }
    function readAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    const newPhoto = document.createElement('input');
    newPhoto.type = 'file';
    const editPhoto = document.createElement('input');
    editPhoto.type = 'file';

    let newPhotoDataURL = null;
    let currentId = null;
    function loadFriend(id){ return JSON.parse(localStorage.getItem('friend-'+id)||'null'); }
    function saveFriend(f){ localStorage.setItem('friend-'+f.id, JSON.stringify(f)); }

    // ========== 新規登録の写真読み込み ==========
    newPhoto.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      if (isHEIC(f)) {
        alert('この写真はHEIC形式の可能性があり、表示できません。iPhoneの設定を「互換性優先（JPEG）」に変更するか、JPEG/PNGに変換してください。');
        return;
      }
      try{
        newPhotoDataURL = await readAsDataURL(f);
      }catch(err){
        alert('画像の読み込みに失敗しました：' + err.message);
      }
    });

    // ========== 編集画面の写真読み込み ==========
    editPhoto.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      if (isHEIC(file)) {
        alert('この写真はHEIC形式の可能性があり、表示できません。iPhoneの設定を「互換性優先（JPEG）」に変更するか、JPEG/PNGに変換してください。');
        return;
      }
      try{
        const dataURL = await readAsDataURL(file);
        const f = loadFriend(currentId); if(!f) return;
        f.photoDataURL=dataURL; saveFriend(f);
      }catch(err){
        alert('画像の読み込みに失敗しました：' + err.message);
      }
    });

    // ========== 付箋処理 ==========
    function hasURL(text){
      return /https?:\/\//.test(text);
    }
    function linkify(text){
      return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }
    function randomColorId(){ return Math.floor(Math.random()*5)+1; }
    function formatNoteTextForDisplay(text){ return text; }

    function createNote({text,x=40,y=40,colorId=randomColorId()}){
      const note=document.createElement('div'); note.className='note'; note.dataset.color=String(colorId);
      note.style.left=x+'px'; note.style.top=y+'px';
      const close=document.createElement('button'); close.type='button'; close.className='close'; close.textContent='×';
      const content=document.createElement('div'); content.className='content';
      const displayText = formatNoteTextForDisplay(text);
      if (!hasURL(text) && displayText.length <= 12) {
        content.classList.add('single-line');
      }
      content.innerHTML = linkify(displayText).replace(/\n/g,'<br>');
      note.appendChild(close); note.appendChild(content);
      return note;
    }
  </script>
</body>
</html>
