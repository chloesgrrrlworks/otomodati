<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>お友達記録アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-180.png" />
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fafafa;--fg:#222;--card:#fff;--muted:#666;--border:#e6e6e6;--btn:#fff;--btn-bd:#ddd;--link:#1a73e8;
      --note1:#FFF6A3;--note2:#FFD5E5;--note3:#C9F0FF;--note4:#CFF8C6;--note5:#E9DCFF;--danger:#d84a4a;
    }
    [data-theme="dark"]{
      --bg:#111215;--fg:#eee;--card:#1a1c20;--muted:#a0a4ab;--border:#2a2d33;--btn:#20242a;--btn-bd:#343842;--link:#7ab4ff;
      --note1:#6a641f;--note2:#6a3347;--note3:#244655;--note4:#2b5230;--note5:#3d3a63;
    }
    [data-theme="hc"]{
      --bg:#fff;--fg:#000;--card:#fff;--muted:#000;--border:#000;--btn:#fff;--btn-bd:#000;--link:#00f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans JP",sans-serif}
    header{position:sticky;top:0;z-index:10;display:flex;gap:.75rem;align-items:center;background:var(--card);border-bottom:1px solid var(--border);padding:.75rem 1rem}
    header h1{margin:0;font-size:1.05rem}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--btn-bd);background:var(--btn);color:var(--fg);padding:.5rem .8rem;border-radius:.6rem;cursor:pointer}
    .btn.primary{background:var(--fg);color:var(--bg);border-color:var(--fg)}
    .container{max-width:1000px;margin:0 auto;padding:1rem}
    .grid{display:grid;gap:12px}
    .grid.cards{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card .ph{aspect-ratio:4/3;background:#e9e9e9;display:grid;place-items:center;color:#999}
    [data-theme="dark"] .card .ph{background:#2a2d33;color:#777}
    .card .body{padding:.75rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    label{font-size:.85rem;color:var(--muted)}
    input,select,textarea{font:inherit;border:1px solid var(--btn-bd);background:var(--btn);color:var(--fg);padding:.5rem .6rem;border-radius:.5rem}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    footer{display:flex;justify-content:center;align-items:center;gap:.5rem;color:var(--muted);padding:1rem}
    footer img{height:20px}

    /* 編集ビュー（付箋） */
    .stage{position:relative;width:100%;aspect-ratio:4/3;background:#e0e0e0;overflow:hidden;border-radius:12px}
    [data-theme="dark"] .stage{background:#2a2d33}
    .stage img{width:100%;height:100%;object-fit:cover;display:block}
    .note{position:absolute;min-width:120px;max-width:240px;min-height:80px;padding:10px 12px 24px 12px;border-radius:8px;
      box-shadow:0 4px 10px rgba(0,0,0,.18);font-family:"Yomogi",cursive;font-size:16px;line-height:1.4;cursor:grab;user-select:none;touch-action:none;border:1px solid rgba(0,0,0,.06);
      word-break: normal; overflow-wrap: anywhere;}
    .note.dragging{opacity:.85;cursor:grabbing}
    .note .close{position:absolute;right:6px;top:6px;width:24px;height:24px;border-radius:999px;background:#fff;border:2px solid var(--danger);color:var(--danger);font-weight:700;line-height:19px;text-align:center;display:none;cursor:pointer}
    .note.show-close .close{display:inline-block}
    .note[data-color="1"]{background:var(--note1)} .note[data-color="2"]{background:var(--note2)}
    .note[data-color="3"]{background:var(--note3)} .note[data-color="4"]{background:var(--note4)} .note[data-color="5"]{background:var(--note5)}
    .overlay{position:absolute;inset:0;background:rgba(120,120,120,.45);display:none;align-items:flex-end;justify-content:flex-end;padding:8px;color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .goodbye .overlay{display:flex}
    .info{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;margin-top:.75rem}
    .hint{opacity:.75;font-size:.9rem}

    /* view toggles */
    [data-view]{display:none}
    [data-view].on{display:block}

    /* モーダルの簡易スタイル */
    dialog{border:1px solid var(--border);border-radius:12px;padding:0;background:var(--card);color:var(--fg);max-width:520px;width:min(92vw,520px)}
    dialog::backdrop{background:rgba(0,0,0,.3)}
    .error{color:#b00020;font-size:.85rem}
    .invalid{border-color:#b00020 !important; outline:0}

    /* 付箋テキスト制御 */
    .note .content{ white-space: pre-wrap; }
    .note .content.single-line{ white-space: nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>お友達記録アプリ</h1>
    <div class="spacer"></div>
    <div class="toolbar">
      <select id="themeSel" class="btn" aria-label="テーマ">
        <option value="light">ライト</option>
        <option value="dark">ダーク</option>
        <option value="hc">高コントラスト</option>
      </select>
      <button class="btn" id="btnBack" style="display:none">← 一覧へ</button>
      <button class="btn primary" id="goNew">＋ 新規登録</button>
    </div>
  </header>

  <div class="container">
    <!-- 1) トップ（一覧） -->
    <section id="view-list" data-view class="on">
      <div id="list" class="grid cards"></div>
      <footer>
        <img src="CGW_LOGO.png" alt="CGW" />
        <small>Chloe's Grrrl Works</small>
      </footer>
    </section>

    <!-- 2) 新規登録 -->
    <section id="view-new" data-view>
      <div class="card">
        <div class="body grid" style="gap:.8rem">
          <div class="row"><label style="min-width:6rem">名前</label><input id="new-name" placeholder="クロエ"></div>
          <div class="row"><label style="min-width:6rem">犬種</label><input id="new-breed" placeholder="フラットコーテッドレトリーバー"></div>
          <div class="row"><label style="min-width:6rem">カラー</label><input id="new-color" placeholder="ブラック"></div>
          <div class="row"><label style="min-width:6rem">年齢</label><input id="new-age" placeholder="3"></div>
          <div class="row"><label style="min-width:6rem">初回入力日</label><input id="new-created" type="date"></div>
          <div class="row" style="align-items:flex-start">
            <label style="min-width:6rem">写真</label>
            <div class="grid" style="grid-template-columns: 1fr auto;gap:.5rem;align-items:center">
              <input type="file" id="new-photo" accept="image/*">
              <small class="hint">選ばない場合は後で追加できます</small>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end;gap:.5rem">
            <button class="btn" id="cancelNew">キャンセル</button>
            <button class="btn primary" id="saveNew">保存して編集へ</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) 個別編集 -->
    <section id="view-edit" data-view>
      <div class="row" style="justify-content:space-between;margin:.25rem 0 .75rem">
        <div class="toolbar">
          <label class="btn" for="edit-photo">写真を選ぶ</label>
          <input id="edit-photo" type="file" accept="image/*" style="display:none" />
          <label class="btn"><input type="checkbox" id="chkConfirm" checked> 削除確認</label>
          <button class="btn" id="btnAddNote">＋付箋</button>
          <button class="btn" id="btnMetToday">今日会った</button>
          <button class="btn" id="btnExport">バックアップ保存</button>
          <label class="btn" for="btnImport">バックアップ復元</label>
          <input id="btnImport" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div id="card" class="card">
        <div id="stage" class="stage">
          <img id="photo" alt="friend photo" src="">
          <div class="overlay">お別れ（目安）：<span id="goodbyeText">—</span></div>
        </div>
        <div class="info" style="margin-bottom:.5rem;padding-top:.5rem">
          <div class="row" style="flex-direction:column"><label>名前</label><input id="name"></div>
          <div class="row" style="flex-direction:column"><label>犬種</label><input id="breed"></div>
          <div class="row" style="flex-direction:column"><label>カラー</label><input id="color"></div>
          <div class="row" style="flex-direction:column"><label>年齢</label><input id="age"></div>
          <div class="row" style="flex-direction:column"><label>入力日</label><input id="created" type="date"></div>
        </div>
      </div>

      <!-- 付箋追加モーダル -->
      <dialog id="noteModal">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700">付箋を追加</div>
        <div style="padding:14px 16px">
          <textarea id="noteText" placeholder="テキストを入力（URLは自動でリンク化）
※『お別れ』を含めると、お別れ（目安）を設定できます" style="width:100%;min-height:120px"></textarea>
        </div>
        <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end">
          <button class="btn" id="cancelModal">キャンセル</button>
          <button class="btn primary" id="saveNote">追加</button>
        </div>
      </dialog>

      <!-- お別れ（目安）モーダル -->
      <dialog id="goodbyeModal">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700">お別れ（目安）の記録</div>
        <div style="padding:14px 16px">
          <input id="goodbyeInput" placeholder="例：2025年春頃／去年の秋／5月の連休明けくらい" style="width:100%;padding:.6rem;border:1px solid var(--btn-bd);background:var(--btn);color:var(--fg);border-radius:.5rem;" />
        </div>
        <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end">
          <button class="btn" id="goodbyeCancel">キャンセル</button>
          <button class="btn primary" id="goodbyeSave">保存</button>
        </div>
      </dialog>
    </section>
  </div>

  <script>
    // ========= 共通 =========
    const $ = sel => document.querySelector(sel);
    const themeSel = $('#themeSel');
    function setThemeMeta(t){ document.querySelector('meta[name="theme-color"]').setAttribute('content', t==='dark'?'#111215':'#ffffff'); }
    (function initTheme(){
      const t = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', t);
      themeSel.value = t; setThemeMeta(t);
      themeSel.addEventListener('change', ()=>{
        const v = themeSel.value;
        document.documentElement.setAttribute('data-theme', v);
        localStorage.setItem('theme', v); setThemeMeta(v);
      });
    })();

    const routes = { list:'#/list', add:'#/new', edit:'#/edit' }; // #/edit/:id
    const views = { list:$('#view-list'), add:$('#view-new'), edit:$('#view-edit') };
    const btnBack = $('#btnBack');
    function show(view){
      Object.values(views).forEach(v=>v.classList.remove('on'));
      views[view].classList.add('on');
      btnBack.style.display = (view==='list') ? 'none' : 'inline-block';
    }

    // ========= モデル =========
    function loadFriends(){ try { return JSON.parse(localStorage.getItem('friends')||'[]'); } catch(e){ return []; } }
    function saveFriends(arr){ localStorage.setItem('friends', JSON.stringify(arr)); }
    function uuid(){ return 'f-' + Math.random().toString(36).slice(2,10); }

    // 初回デモ（空なら1件）
    (function seed(){
      const fs = loadFriends();
      if(fs.length===0){
        const today = new Date(); const y=today.getFullYear(); const m=String(today.getMonth()+1).padStart(2,'0'); const d=String(today.getDate()).padStart(2,'0');
        const demo = {
          id: uuid(), name:'クロエ', breed:'フラットコーテッドレトリーバー', color:'ブラック', age:'3',
          created: `${y}-${m}-${d}`, photoDataURL:'CGW_LOGO.png', goodbye:'—', goodbyeActive:false, deleteConfirm:true,
          demo: true,
          notes: [
            {text:`出会い：${y}-${m}-${d}`, x:24, y:24, colorId:1},
            {text:'あだ名：クロちゃん', x:220, y:60, colorId:3},
            {text:'出会った場所：代々木公園', x:24, y:120, colorId:2}
          ]
        };
        saveFriends([demo]);
      }
    })();

    // ========= トップ（一覧） =========
    const listEl = document.getElementById('list');
    function renderList(){
      const fsAll = loadFriends();
      const hasReal = fsAll.some(f => !f.demo);
      const data = hasReal ? fsAll.filter(f => !f.demo) : fsAll;
      listEl.innerHTML = '';
      data.forEach(f=>{
        const card = document.createElement('div'); card.className='card';
        const ph = document.createElement('div'); ph.className='ph';
        if(f.photoDataURL){ const img=new Image(); img.src=f.photoDataURL; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; ph.innerHTML=''; ph.appendChild(img); }
        else { ph.textContent='No Photo'; }
        const body = document.createElement('div'); body.className='body';
        body.innerHTML = `<div style="font-weight:700">${f.name||'(無名)'}</div>
          <div class="hint">${f.breed||'-'}／${f.color||'-'}／${f.age||'-'}歳</div>
          <div class="row" style="justify-content:flex-end;margin-top:.5rem">
            <button class="btn" data-id="${f.id}">編集</button>
          </div>`;
        card.appendChild(ph); card.appendChild(body); listEl.appendChild(card);
      });
      listEl.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', ()=> location.hash = `${routes.edit}/${b.dataset.id}`);
      });
    }

    // 新規登録ビューの入力
    const newName = document.getElementById('new-name'),
          newBreed=document.getElementById('new-breed'),
          newColor=document.getElementById('new-color'),
          newAge=document.getElementById('new-age'),
          newCreated=document.getElementById('new-created'),
          newPhoto=document.getElementById('new-photo');
    newCreated.valueAsDate = new Date();
    document.getElementById('cancelNew').addEventListener('click', ()=> location.hash = routes.list);
    let newPhotoDataURL = '';

    // iPhone HEIC 対策
    function isHEIC(file){
      const name = (file?.name || '').toLowerCase();
      const type = (file?.type || '').toLowerCase();
      return type.includes('heic') || name.endsWith('.heic') || type.includes('heif');
    }
    function readAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
    newPhoto.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      if (isHEIC(f)) {
        alert('この写真はHEIC形式の可能性があり、ブラウザで表示できません。iPhoneの「設定 > カメラ > フォーマット」で“互換性優先（JPEG）”にするか、HEICをJPEG/PNGに変換してから選んでください。');
        return;
      }
      try{ newPhotoDataURL = await readAsDataURL(f); }
      catch(err){ alert('画像の読み込みに失敗しました：' + err.message); }
    });

    document.getElementById('saveNew').addEventListener('click', ()=>{
      const createdVal = newCreated.value || new Date().toISOString().slice(0,10);
      const baseX = 24, baseY = 24;
      const notesInit = [
        { text: `出会い：${createdVal}`, x: baseX, y: baseY, colorId: 1 },
        { text: `あだ名：—`,   x: baseX + 196, y: baseY + 16, colorId: 3 },
        { text: `出会った場所：—`, x: baseX, y: baseY + 96, colorId: 2 }
      ];
      const f = {
        id: 'f-' + Math.random().toString(36).slice(2,10),
        name: newName.value.trim(),
        breed: newBreed.value.trim(),
        color: newColor.value.trim(),
        age: newAge.value.trim(),
        created: createdVal,
        photoDataURL: (typeof newPhotoDataURL === 'string' ? newPhotoDataURL : '') || '',
        goodbye: '—',
        goodbyeActive: false,
        deleteConfirm: true,
        notes: notesInit
      };
      const fs = loadFriends().filter(x => !x.demo);
      fs.push(f); saveFriends(fs);
      location.hash = `${routes.edit}/${f.id}`;
    });

    // ========= 個別編集 =========
    const stage = document.getElementById('stage'),
          cardEl = document.getElementById('card'),
          photo = document.getElementById('photo');
    const nameEl=document.getElementById('name'),
          breedEl=document.getElementById('breed'),
          colorEl=document.getElementById('color'),
          ageEl=document.getElementById('age'),
          createdEl=document.getElementById('created');
    const noteModal = document.getElementById('noteModal'),
          noteText = document.getElementById('noteText');
    const goodbyeModal = document.getElementById('goodbyeModal'),
          goodbyeInput = document.getElementById('goodbyeInput'),
          goodbyeTextEl = document.getElementById('goodbyeText');
    const editPhoto = document.getElementById('edit-photo'),
          chkConfirm = document.getElementById('chkConfirm');
    const btnAddNote=document.getElementById('btnAddNote'),
          btnMetToday=document.getElementById('btnMetToday'),
          btnExport=document.getElementById('btnExport'),
          btnImport=document.getElementById('btnImport');

    function randomColorId(){ return 1 + Math.floor(Math.random()*5); }
    function clamp(n, mi, ma){ return Math.min(Math.max(n, mi), ma); }

    function linkify(t){ return t.replace(/(https?:\/\/[^\s]+)/g, s=>`<a href="${s}" target="_blank" rel="noreferrer noopener">${s}</a>`); }
    function hasURL(t){ return /(https?:\/\/[^\s]+)/.test(t); }
    function formatNoteTextForDisplay(t){
      if (hasURL(t)) return (t||'');
      const raw = (t||'').replace(/\r?\n/g, '');
      const cut = raw.slice(0, 24);
      if (cut.length <= 12) return cut;
      return cut.slice(0,12) + '\n' + cut.slice(12);
    }

    let currentId = null;
    function loadFriendById(id){ return loadFriends().find(f=>f.id===id); }
    function saveFriendByObj(obj){
      const fs = loadFriends(); const i = fs.findIndex(x=>x.id===obj.id);
      if(i>=0){ fs[i]=obj; saveFriends(fs); }
    }

    function bindEdit(f){
      currentId = f.id;
      photo.src = f.photoDataURL || '';
      nameEl.value=f.name||''; breedEl.value=f.breed||''; colorEl.value=f.color||''; ageEl.value=f.age||''; createdEl.value=f.created||'';
      goodbyeTextEl.textContent = f.goodbye || '—'; if(f.goodbyeActive) cardEl.classList.add('goodbye'); else cardEl.classList.remove('goodbye');
      chkConfirm.checked = !!f.deleteConfirm;
      stage.querySelectorAll('.note').forEach(n=>n.remove());
      (f.notes||[]).forEach(n=> createNote(n, f));
    }

    function createNote({text,x=40,y=40,colorId=randomColorId()}, f){
      const note=document.createElement('div'); note.className='note'; note.dataset.color=String(colorId); note.dataset.text=text;
      note.style.left=x+'px'; note.style.top=y+'px';
      const close=document.createElement('button'); close.type='button'; close.className='close'; close.textContent='×'; close.title='削除';
      close.addEventListener('click', e=>{
        e.stopPropagation();
        if(chkConfirm.checked && !confirm('この付箋を削除しますか？')) return;
        f.notes = (f.notes||[]).filter(n=> !(n.text===text && n.x===x && n.y===y && n.colorId===colorId));
        saveFriendByObj(f); note.remove();
      });
      const content=document.createElement('div'); content.className='content';
      const displayText = formatNoteTextForDisplay(text);
      if (!hasURL(text) && displayText.length <= 12) { content.classList.add('single-line'); }
      content.innerHTML = linkify(displayText).replace(/\n/g,'<br>');
      note.appendChild(close); note.appendChild(content);

      note.addEventListener('click', e=>{ if(e.target.closest('.close')) return; if(!note.classList.contains('dragging')) note.classList.toggle('show-close'); });

      let dragging=false, offX=0, offY=0;
      note.addEventListener('pointerdown', e=>{
        if(e.target.closest('.close')) return;
        dragging=true; note.classList.add('dragging'); note.setPointerCapture(e.pointerId);
        const r=note.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top;
      });
      note.addEventListener('pointermove', e=>{
        if(!dragging) return;
        const s=stage.getBoundingClientRect(), n=note.getBoundingClientRect();
        const L=clamp(e.clientX - s.left - offX, 0, Math.max(0, s.width - n.width));
        const T=clamp(e.clientY - s.top  - offY, 0, Math.max(0, s.height - n.height));
        note.style.left=L+'px'; note.style.top=T+'px';
      });
      function stopDrag(){
        if(!dragging) return; dragging=false; note.classList.remove('dragging');
        const idx = (f.notes||[]).findIndex(n=> n.text===text && n.x===x && n.y===y && n.colorId===colorId);
        if(idx>=0){ f.notes[idx].x=parseFloat(note.style.left)||0; f.notes[idx].y=parseFloat(note.style.top)||0; saveFriendByObj(f); }
      }
      note.addEventListener('pointerup', stopDrag); note.addEventListener('pointercancel', stopDrag);

      stage.appendChild(note);
      if(/お別れ/.test(text)){ setTimeout(()=> openGoodbyeModal(f), 0); }
      return note;
    }

    function openNoteModal(pref=''){ noteText.value=pref; noteModal.showModal(); setTimeout(()=>noteText.focus(),0); }
    document.getElementById('cancelModal').addEventListener('click', ()=> noteModal.close());
    document.getElementById('saveNote').addEventListener('click', ()=>{
      const t = noteText.value.trim(); if(!t) return;
      const f = loadFriendById(currentId); if(!f) return;
      const n = {text:t, x: 40+Math.random()*60, y: 40+Math.random()*40, colorId: randomColorId()};
      f.notes = f.notes||[]; f.notes.push(n); saveFriendByObj(f); createNote(n, f); noteModal.close();
    });

    btnAddNote.addEventListener('click', ()=> openNoteModal());
    btnMetToday.addEventListener('click', ()=>{
      const today=new Date(); const y=today.getFullYear(); const m=String(today.getMonth()+1).padStart(2,'0'); const d=String(today.getDate()).padStart(2,'0');
      const t=`今日会った：${y}-${m}-${d}`; const f = loadFriendById(currentId); if(!f) return;
      const n={text:t, x:80+Math.random()*120, y:60+Math.random()*80, colorId: randomColorId()}; f.notes.push(n); saveFriendByObj(f); createNote(n, f);
    });

    [nameEl,breedEl,colorEl,ageEl,createdEl].forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const f = loadFriendById(currentId); if(!f) return;
        f.name=nameEl.value; f.breed=breedEl.value; f.color=colorEl.value; f.age=ageEl.value; f.created=createdEl.value; saveFriendByObj(f);
      });
    });

    editPhoto.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      if (isHEIC(file)) {
        alert('この写真はHEIC形式の可能性があり、ブラウザで表示できません。iPhoneの設定を“互換性優先（JPEG）”にするか、HEICをJPEG/PNGに変換してから選んでください。');
        return;
      }
      try{
        const dataURL = await readAsDataURL(file);
        const f = loadFriendBy
